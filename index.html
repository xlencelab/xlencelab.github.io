<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xlence AI - Create Smarter With AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #1a1a1a;
            --secondary: #333;
            --accent: #666;
            --text: #f5f5f5;
            --bg: #121212;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-text-color: #f5f5f5; /* Default for dark mode */
        }

        /* Light Mode Variables */
        body.light-mode {
            --primary: #f0f0f0;
            --secondary: #e0e0e0;
            --accent: #999;
            --text: #333;
            --bg: #ffffff;
            --gradient: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%); /* Example light mode gradient */
            --gradient-text-color: #333; /* Darker text for light mode gradient */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            transition: all 0.5s ease;
        }
        
        .nav-item {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            color: var(--text); /* Ensure nav item text color adapts */
        }
        
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient);
            transition: width 0.3s ease;
        }
        
        .nav-item:hover::after {
            width: 100%;
        }
        
        .nav-item.active::after {
            width: 100%;
        }
        
        .page {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            display: none;
        }
        
        .page.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 18px;
            animation: fadeIn 0.4s ease-out;
            transform-origin: bottom;
        }
        
        .user-message {
            background: var(--gradient);
            margin-left: auto;
            border-bottom-right-radius: 4px;
            color: white; /* User message text should remain white for contrast */
        }
        
        .ai-message {
            background-color: var(--primary);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--secondary);
            color: var(--text); /* Ensure AI message text color adapts */
        }

        /* Added styles for AI message formatting */
        .ai-message p {
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            color: var(--text); /* Ensure paragraph text color adapts */
        }

        .ai-message strong {
            font-weight: bold;
            color: var(--gradient); /* Apply gradient to bold text */
        }

        .ai-message ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 5px;
        }

        .ai-message ol {
            list-style-type: decimal;
            margin-left: 20px;
            padding-left: 5px;
        }

        .ai-message li {
            margin-bottom: 5px;
        }
        
        .review-card {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            transform: perspective(1000px) rotateY(15deg);
            transition: all 0.4s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text); /* Ensure review card text color adapts */
        }
        
        .review-card:hover {
            transform: perspective(1000px) rotateY(0deg) translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .team-member {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s ease;
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text); /* Ensure team member text color adapts */
        }
        
        .team-member.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--primary);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 80%;
            margin: 8px 0;
            border: 1px solid var(--secondary);
            color: var(--text); /* Ensure typing indicator text color adapts */
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text);
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .floating {
            animation: float 6s ease-in-out infinite;
        }
        
        .gradient-text {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: var(--gradient-text-color); /* Fallback for non-webkit, but primarily for contrast */
        }
        
        /* Custom Scrollbar Styles */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            transition: all 0.3s ease;
            animation: scrollPulse 2s ease-in-out infinite;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
            animation: none;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:active {
            background: rgba(255, 255, 255, 0.4);
        }
        
        @keyframes scrollPulse {
            0%, 100% {
                background: rgba(255, 255, 255, 0.15);
                transform: scaleY(1);
            }
            50% {
                transform: scaleY(1.1);
            }
        }
        
        /* Mobile specific styles */
        @media (max-width: 768px) {
            .nav-menu {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--primary);
                padding: 10px;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
                z-index: 100;
                border-top: 1px solid var(--secondary);
                flex-direction: row; /* Ensure horizontal layout for mobile nav items */
                justify-content: space-around; /* Distribute items evenly */
                align-items: center;
            }

            .nav-menu .flex-col {
                flex-direction: row; /* Override flex-col for mobile nav items */
                width: 100%;
                justify-content: space-around;
                align-items: center;
            }

            .nav-menu .space-y-6 > .nav-item {
                margin-top: 0 !important; /* Remove vertical spacing */
            }

            .nav-menu .space-x-4 {
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
                align-items: center;
                margin-left: 0 !important; /* Remove default margin */
            }

            .nav-menu .nav-item {
                padding: 8px 4px; /* Adjust padding for smaller screens */
                font-size: 0.75rem; /* Smaller font size */
                flex-grow: 1; /* Allow items to grow and fill space */
                text-align: center;
            }

            .nav-menu .nav-item svg {
                margin-right: 0; /* Remove margin for icons */
                width: 20px; /* Adjust icon size */
                height: 20px;
            }

            .nav-menu .nav-item span {
                display: block; /* Stack text below icon */
                font-size: 0.65rem; /* Even smaller font for text */
            }

            .nav-menu .auth-container {
                display: none; /* Hide auth button in mobile nav, can be moved to a modal or separate page */
            }
            
            .chat-container {
                padding-bottom: 80px; /* Make space for fixed bottom nav */
            }
            
            .message {
                max-width: 90%;
            }

            .main-content {
                margin-left: 0; /* No left margin on mobile */
                width: 100%;
            }

            .notes-container {
                flex-direction: column;
                height: auto; /* Allow height to adjust */
            }

            .notes-sidebar {
                width: 100%;
                height: auto;
                max-height: 200px; /* Limit height on mobile */
                margin-bottom: 1rem;
            }

            .notes-editor {
                width: 100%;
            }

            .review-card {
                transform: none; /* Remove 3D transform on mobile */
                margin-bottom: 1rem; /* Add some space between cards */
            }

            .review-card:hover {
                transform: none; /* Remove hover transform on mobile */
            }

            .team-member {
                margin-bottom: 1rem; /* Add space between team members */
            }

            .modal-content {
                width: 95%; /* Slightly wider modal on small screens */
                padding: 1.5rem;
            }
        }
        
        /* Tablet specific styles (adjust as needed, often between 768px and 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .nav-menu {
                width: 150px; /* Slightly narrower nav on tablets */
                padding: 15px;
            }

            .main-content {
                margin-left: 150px;
                width: calc(100% - 150px);
            }

            .nav-menu .nav-item {
                font-size: 0.9rem;
                padding: 10px 8px;
            }

            .nav-menu .nav-item svg {
                width: 20px;
                height: 20px;
            }

            .chat-container {
                max-width: 700px; /* Adjust chat width */
            }

            .notes-sidebar {
                width: 200px; /* Adjust sidebar width */
            }
        }

        /* Desktop specific styles */
        @media (min-width: 1025px) { /* Changed from 769px to 1025px for clearer desktop breakpoint */
            .nav-menu {
                position: fixed;
                top: 0;
                left: 0;
                width: 200px;
                height: 100vh;
                background: var(--primary);
                padding: 20px;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
                border-right: 1px solid var(--secondary);
                flex-direction: column; /* Stack vertically on desktop */
                justify-content: flex-start;
                align-items: flex-start;
            }

            .nav-menu .flex-col {
                flex-direction: column;
                width: auto;
                justify-content: flex-start;
                align-items: flex-start;
            }

            .nav-menu .space-y-6 > .nav-item {
                margin-top: 1.5rem !important; /* Restore vertical spacing */
            }

            .nav-menu .space-x-4 {
                flex-direction: column;
                width: auto;
                justify-content: flex-start;
                align-items: flex-start;
                margin-left: 0 !important;
            }

            .nav-menu .nav-item {
                padding: 8px 16px; /* Restore desktop padding */
                font-size: 1.125rem; /* Restore desktop font size */
                flex-grow: 0;
                text-align: left;
            }

            .nav-menu .nav-item svg {
                margin-right: 8px; /* Restore margin for icons */
                width: 20px; /* Restore icon size */
                height: 20px;
            }

            .nav-menu .nav-item span {
                display: inline; /* Display text next to icon */
                font-size: 1.125rem; /* Restore font size */
            }

            .nav-menu .auth-container {
                display: block; /* Show auth button on desktop */
                width: 100%;
                padding: 0 20px;
                box-sizing: border-box;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
            
            .chat-container {
                max-width: 800px;
                margin: 0 auto;
            }

            .notes-container {
                flex-direction: row;
                height: calc(100vh - 100px); /* Restore desktop height */
            }

            .notes-sidebar {
                width: 250px;
                height: calc(100vh - 100px); /* Restore desktop height */
                margin-right: 1.5rem;
            }

            .notes-editor {
                flex-grow: 1;
            }

            .review-card {
                transform: perspective(1000px) rotateY(15deg); /* Restore 3D transform on desktop */
                margin-bottom: 0;
            }

            .review-card:hover {
                transform: perspective(1000px) rotateY(0deg) translateY(-10px); /* Restore hover transform */
            }

            .team-member {
                margin-bottom: 0;
            }
        }

        /* Custom Sign-in/Sign-up Button Styling */
        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent; /* Transparent background */
            color: var(--text); /* Use text color for monochrome effect */
            border: 1px solid var(--accent); /* Subtle border */
            border-radius: 5px;
            padding: 8px 12px; /* Adjusted padding for better fit */
            cursor: pointer;
            font-family: 'Inter', sans-serif; /* Use Inter font */
            font-size: 14px; /* Adjusted font size */
            font-weight: 500;
            box-shadow: none; /* Remove shadow */
            transition: all 0.3s ease;
            width: 100%; /* Make it take full width of its container */
            max-width: 160px; /* Limit max width for desktop nav */
            margin: 0 auto; /* Center in nav for desktop */
        }

        @media (min-width: 769px) {
            .auth-button {
                margin-top: 20px; /* Add some space from nav items */
            }
        }
        
        .auth-button:hover {
            background-color: rgba(255, 255, 255, 0.08); /* Subtle hover effect */
        }

        .auth-button svg {
            width: 18px; /* Adjusted icon size */
            height: 18px; /* Adjusted icon size */
            margin-right: 8px; /* Adjusted margin */
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--primary);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            color: var(--text); /* Ensure modal content text color adapts */
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text);
            cursor: pointer;
        }

        .modal-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--secondary);
            border-radius: 5px;
            background-color: var(--bg);
            color: var(--text);
        }

        .modal-submit-button {
            width: 100%;
            padding: 0.75rem;
            border-radius: 5px;
            background: var(--gradient);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .modal-submit-button:hover {
            opacity: 0.9;
        }

        .modal-switch-text {
            text-align: center;
            margin-top: 1rem;
            color: var(--accent);
        }

        .modal-switch-text span {
            cursor: pointer;
            color: var(--gradient);
            font-weight: bold;
        }

        /* Custom Toast Notification */
        .toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }

        .toast-notification.success {
            background-color: #4CAF50; /* Green for success */
        }

        .toast-notification.error {
            background-color: #f44336; /* Red for error */
        }

        /* Seed Phrase Display */
        .seed-phrase-display {
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--gradient);
            word-break: break-all;
        }

        /* Notes Specific Styles */
        .notes-container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 100px); /* Adjust based on header/footer if any */
        }

        .notes-sidebar {
            background: var(--primary);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: var(--text); /* Ensure notes sidebar text color adapts */
        }

        .notes-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .notes-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem; /* For scrollbar */
        }

        .notes-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text); /* Ensure notes list item text color adapts */
        }

        .notes-list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .notes-list-item.active {
            background: var(--gradient);
            color: white;
        }

        .notes-list-item-title {
            flex-grow: 1;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .notes-delete-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            margin-left: 0.5rem;
            transition: color 0.2s ease;
        }

        .notes-list-item.active .notes-delete-btn {
            color: white; /* Adjust color for active state */
        }

        .notes-delete-btn:hover {
            color: #f44336; /* Red for delete hover */
        }

        .notes-editor {
            background: var(--primary);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: var(--text); /* Ensure notes editor text color adapts */
        }

        .notes-editor-title {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--accent);
            border-radius: 5px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1.25rem;
            font-weight: bold;
        }

        .notes-editor-content {
            flex-grow: 1;
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--accent);
            border-radius: 5px;
            background-color: var(--bg);
            color: var(--text);
            font-size: 1rem;
            line-height: 1.5;
            resize: vertical; /* Allow vertical resizing */
            min-height: 200px; /* Minimum height for editor */
        }

        .notes-editor-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 1rem;
        }

        .notes-editor-save-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            background: var(--gradient);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .notes-editor-save-btn:hover {
            opacity: 0.9;
        }

        .notes-editor-new-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            background-color: var(--accent);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .notes-editor-new-btn:hover {
            background-color: #555;
        }

        .notes-no-user-message {
            text-align: center;
            padding: 2rem;
            background: var(--primary);
            border-radius: 10px;
            margin-top: 2rem;
            color: var(--text); /* Ensure no user message text color adapts */
        }

        /* Theme Switcher Button */
        .theme-switcher {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: var(--primary);
            border: 1px solid var(--secondary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .theme-switcher:hover {
            background-color: var(--secondary);
        }

        .theme-switcher svg {
            width: 24px;
            height: 24px;
            color: var(--text);
            transition: color 0.3s ease;
        }

        /* Specific overrides for elements that need to maintain contrast */
        .chat-dropdown button {
            color: var(--text); /* Ensure dropdown button text color adapts */
        }

        .chat-dropdown button:hover {
            background-color: var(--secondary); /* Ensure hover background adapts */
        }

        .chat-dropdown .text-gray-400 {
            color: var(--accent); /* Adjust for better visibility in light mode */
        }

        .chat-dropdown .text-white {
            color: var(--text); /* Ensure chat history title text color adapts */
        }

        .chat-dropdown .bg-gray-800 {
            background-color: var(--primary); /* Ensure dropdown background adapts */
            border-color: var(--secondary); /* Ensure dropdown border adapts */
        }

        .chat-dropdown .bg-gray-700 {
            background-color: var(--secondary); /* Ensure active/hover background adapts */
        }

        .chat-dropdown .text-red-400 {
            color: #f44336; /* Keep red for error/delete */
        }

        .chat-dropdown .text-green-400 {
            color: #4CAF50; /* Keep green for success/new chat */
        }

        .chat-dropdown .text-blue-400 {
            color: #2196F3; /* Keep blue for info */
        }

        .review-card .text-gray-300 {
            color: var(--text); /* Ensure review text color adapts */
        }

        .review-card .text-gray-400 {
            color: var(--accent); /* Ensure sub-text color adapts */
        }

        .pricing ul span {
            color: var(--text); /* Ensure pricing list item text color adapts */
        }

        .pricing .text-gray-400 {
            color: var(--accent); /* Ensure pricing sub-text color adapts */
        }

        .modal-switch-text span {
            color: var(--gradient); /* Keep gradient for clickable text */
        }

        .seed-phrase-display {
            color: var(--gradient); /* Keep gradient for seed phrase */
        }

        .notes-list-item.active .notes-list-item-title {
            color: white; /* Keep white for active note title */
        }

        .notes-list-item.active .notes-delete-btn {
            color: white; /* Keep white for active note delete button */
        }

        .notes-sidebar-header h2 {
            color: var(--text); /* Ensure notes sidebar header text color adapts */
        }

        .notes-editor-actions button {
            color: white; /* Keep white for action buttons */
        }

        .notes-editor-new-btn {
            background-color: var(--accent); /* Ensure new note button background adapts */
        }

        .notes-editor-new-btn:hover {
            background-color: var(--secondary); /* Ensure new note button hover background adapts */
        }

        /* Input fields */
        input[type="text"], textarea {
            background-color: var(--bg);
            color: var(--text);
            border-color: var(--secondary);
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--gradient);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5); /* Example focus ring color */
        }

        /* Specific fix for chat input background */
        #user-input {
            background-color: var(--primary); /* Use primary for chat input background */
            color: var(--text); /* Ensure text color is readable */
            border-color: var(--secondary); /* Ensure border color adapts */
        }
        #user-input:focus {
            border-color: var(--gradient);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }

        /* Adjust chat dropdown button colors */
        #chat-dropdown-btn {
            background-color: var(--primary);
            border-color: var(--secondary);
            color: var(--text);
        }
        #chat-dropdown-btn:hover {
            background-color: var(--secondary);
        }

        /* Adjust chat dropdown content colors */
        #chat-dropdown {
            background-color: var(--primary);
            border-color: var(--secondary);
        }
        #chat-dropdown button {
            color: var(--text);
        }
        #chat-dropdown button:hover {
            background-color: var(--secondary);
        }
        #chat-dropdown .border-gray-600 {
            border-color: var(--secondary);
        }

        /* New styles for icon-only buttons */
        .nav-item-icon-only {
            padding: 8px; /* Adjust padding for icon-only buttons */
            width: 40px; /* Fixed width for circular appearance */
            height: 40px; /* Fixed height for circular appearance */
            border-radius: 50%; /* Make it circular */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: var(--text);
            background-color: transparent; /* Ensure transparent background */
            border: 1px solid var(--accent); /* Subtle border */
        }

        .nav-item-icon-only:hover {
            background-color: rgba(255, 255, 255, 0.08); /* Subtle hover effect */
        }

        .nav-item-icon-only svg {
            margin-right: 0; /* Remove margin for icons */
            width: 20px; /* Adjust icon size */
            height: 20px;
        }

        .nav-item-icon-only span {
            display: none; /* Hide text */
        }

        /* Adjust auth-container for side-by-side icons */
        .auth-container .flex {
            display: flex;
            flex-direction: row; /* Arrange horizontally */
            gap: 10px; /* Space between icons */
            justify-content: center; /* Center the icons */
            width: 100%; /* Take full width of container */
        }

        /* Ensure auth-button also adapts to icon-only style if needed */
        .auth-container .auth-button {
            max-width: none; /* Remove max-width constraint */
            width: auto; /* Adjust width based on content */
            padding: 8px 12px; /* Keep original padding for sign in/out button */
        }

        /* Specific adjustment for mobile nav to ensure icons are centered and spaced */
        @media (max-width: 768px) {
            .nav-menu .auth-container .flex {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                width: 100%;
            }
            .nav-menu .auth-container .nav-item-icon-only {
                flex-grow: 1; /* Allow icons to grow and fill space */
                width: auto; /* Override fixed width for mobile */
                border-radius: 0; /* Remove circular shape for mobile nav items */
                padding: 8px 4px; /* Adjust padding for smaller screens */
            }
            .nav-menu .auth-container .nav-item-icon-only svg {
                margin-right: 0;
            }
            .nav-menu .auth-container .nav-item-icon-only span {
                display: block; /* Show text below icon for mobile nav */
                font-size: 0.65rem;
            }
        }

        /* Desktop specific adjustments for auth-container icons */
        @media (min-width: 1025px) {
            .auth-container .flex {
                flex-direction: row; /* Keep horizontal for desktop */
                justify-content: center; /* Center icons */
                margin-top: 10px; /* Add some space below sign in/out button */
            }
            .auth-container .nav-item-icon-only {
                width: 40px; /* Restore fixed width for circular appearance */
                height: 40px; /* Restore fixed height for circular appearance */
                border-radius: 50%; /* Restore circular shape */
            }
            .auth-container .nav-item-icon-only span {
                display: none; /* Hide text for desktop icon-only buttons */
            }
        }

        /* Connect Page Specific Styles */
        .connect-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .connect-section {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: var(--text);
        }

        .connect-section h2 {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .group-card {
            background-color: var(--secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-card button {
            background: var(--gradient);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: bold;
            transition: opacity 0.3s ease;
        }

        .group-card button:hover {
            opacity: 0.9;
        }

        .friend-search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--accent);
            border-radius: 5px;
            background-color: var(--bg);
            color: var(--text);
            margin-bottom: 1rem;
        }

        .chat-list-item {
            background-color: var(--secondary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .chat-list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }

        /* About Us Page Specific Styles */
        .about-us-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: var(--text);
        }

        .stat-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--gradient);
        }

        .stat-card .number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text);
            display: block;
            margin-bottom: 0.5rem;
        }

        .stat-card .stars {
            font-size: 2rem;
            color: gold;
        }

        /* Profile Page Specific Styles */
        .profile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            border: 1px solid var(--secondary);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            color: var(--text);
            text-align: center;
        }

        .profile-avatar-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            overflow: hidden;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid var(--gradient);
        }

        .profile-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-avatar-placeholder {
            font-size: 3rem;
            font-weight: bold;
            color: white;
        }

        .profile-avatar-edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            padding: 0.5rem;
            color: white;
            font-size: 1.2rem;
        }

        .profile-input-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        .profile-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .profile-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--accent);
            border-radius: 5px;
            background-color: var(--bg);
            color: var(--text);
        }

        .profile-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--accent);
            border-radius: 5px;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100px;
            resize: vertical;
        }

        .profile-status-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .profile-status-button {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .profile-status-button.active {
            border-color: var(--gradient);
        }

        .profile-status-active {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        .profile-status-idle {
            background-color: #FFC107; /* Dark Yellow */
            color: #333;
        }

        .profile-status-dnd {
            background-color: #f44336; /* Red */
            color: white;
        }

        .profile-save-button {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1.5rem;
            border-radius: 5px;
            background: var(--gradient);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .profile-save-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-menu">
        <div class="flex flex-col items-center md:items-start space-y-6 md:space-y-10">
            <button onclick="switchPage('profile')" class="text-2xl font-bold mb-8 mt-4 text-center md:self-center nav-item">
                <img src="https://cdn.pixabay.com/photo/2016/09/28/02/14/user-1699635_1280.png" alt="Anonymous Profile" class="h-8 w-auto rounded-full" />
            </button>
            
            <div class="flex md:flex-col space-x-4 md:space-x-0 md:space-y-6 w-full">
                <button onclick="switchPage('chat')" class="nav-item px-4 py-2 text-lg font-medium transition-all duration-300 active">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span>Chat</span>
                    </div>
                </button>
                
                <button onclick="switchPage('notes')" class="nav-item px-4 py-2 text-lg font-medium transition-all duration-300">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        <span>Notes</span>
                    </div>
                </button>

                <button onclick="switchPage('connect')" class="nav-item px-4 py-2 text-lg font-medium transition-all duration-300">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Connect</span>
                    </div>
                </button>

                <button onclick="switchPage('about-us')" class="nav-item px-4 py-2 text-lg font-medium transition-all duration-300">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>About Us</span>
                    </div>
                </button>
            </div>
            <!-- Custom Sign-in/Sign-up Button within nav-menu -->
            <div class="auth-container mt-auto mb-4"> <!-- mt-auto pushes it to the bottom -->
                <button id="auth-button" onclick="showAuthModal('signin')" class="auth-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                    <span>Sign In</span>
                </button>
                <!-- Moved Reviews and Pricing below Sign In button, as icon-only buttons -->
                <div class="flex mt-2">
                    <button onclick="switchPage('reviews')" class="nav-item-icon-only">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                        <span>Reviews</span>
                    </button>

                    <button onclick="switchPage('pricing')" class="nav-item-icon-only">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span>Pricing</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content min-h-screen">
        <!-- Chat Page -->
        <div id="chat" class="page active p-4 md:p-8 chat-container">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h1 id="chat-greeting" class="text-3xl md:text-4xl font-bold gradient-text">Welcome!</h1>
                    
                    <!-- Chat Dropdown Menu -->
                    <div class="relative">
                        <button id="chat-dropdown-btn" class="flex items-center space-x-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-all duration-300 border border-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                            <span>Chat Options</span>
                            <svg id="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        
                        <div id="chat-dropdown" class="absolute right-0 top-12 w-96 bg-gray-800 border border-gray-600 rounded-lg shadow-xl opacity-0 invisible transform scale-95 transition-all duration-200 z-50 flex flex-row flex-wrap justify-between items-start p-2">
                            
                            <!-- New Chat Button -->
                            <button onclick="startNewChat()" class="w-full flex items-center space-x-3 px-3 py-2 text-left hover:bg-gray-700 rounded-lg transition-all duration-200 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                <span>New Chat</span>
                            </button>
                            
                            <!-- Chat History Section -->
                            <div class="w-full">
                                <div class="flex items-center space-x-2 px-3 py-2 mt-2 border-t border-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="text-sm text-gray-400 font-medium">Chat History</span>
                                </div>
                                
                                <!-- Chat History List -->
                                <div id="chat-history-list" class="max-h-48 overflow-y-auto custom-scrollbar">
                                    <!-- Dynamic chat history items will be inserted here -->
                                </div>
                            </div>
                            
                            <!-- Clear History Button -->
                            <div class="w-full border-t border-gray-600 pt-2 mt-2">
                                <button onclick="clearChatHistory()" class="w-full flex items-center space-x-3 px-3 py-2 text-left hover:bg-red-900/20 text-red-400 rounded-lg transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    <span class="text-sm">Clear History</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="chat-messages" class="mb-6 space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                    <div class="ai-message">
                        <div class="font-medium mb-1 gradient-text">Xlence AI</div>
                        <p>Hello! How can I help you today?</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <input id="user-input" type="text" placeholder="Type your message..." 
                           class="flex-1 px-4 py-3 rounded-full bg-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all border border-gray-700">
                    <button id="send-btn" class="p-3 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 transition-all transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
                <div id="response-limit-message" class="text-center text-red-400 mt-4 hidden">
                    You have reached your response limit. Please sign in or sign up!
                </div>
            </div>
        </div>
        
        <!-- Reviews Page -->
        <div id="reviews" class="page p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold mb-8 text-center gradient-text">Reviews</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 flex items-center justify-center">
                                <span class="text-xl font-bold">JD</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">John Doe</div>
                                <div class="text-sm text-gray-400">CEO, TechCorp</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"The AI interface transformed our customer service. The sophisticated design and seamless functionality impressed both our team and clients."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>
                    
                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-green-500 to-blue-600 flex items-center justify-center">
                                <span class="text-xl font-bold">SM</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Sarah Miller</div>
                                <div class="text-sm text-gray-400">CTO, InnovateLab</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"Outstanding user experience with intelligent responses. The interface is intuitive and the AI capabilities exceeded our expectations."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>
                    
                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-red-500 to-pink-600 flex items-center justify-center">
                                <span class="text-xl font-bold">MJ</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Michael Johnson</div>
                                <div class="text-sm text-gray-400">Product Manager, NextGen</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"Revolutionary AI technology with a beautiful interface. It's become an essential tool for our daily operations and customer interactions."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>

                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 flex items-center justify-center">
                                <span class="text-xl font-bold">AW</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Alice Williams</div>
                                <div class="text-sm text-gray-400">Founder, Creative Solutions</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"The AI has significantly boosted our productivity. The prompt templates are a game-changer for consistent and high-quality content generation."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>

                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-teal-500 to-cyan-600 flex items-center justify-center">
                                <span class="text-xl font-bold">RB</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Robert Brown</div>
                                <div class="text-sm text-gray-400">Marketing Director, Global Brands</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"Seamless integration and powerful AI. The prioritized responses for Pro users make a noticeable difference during peak hours."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>

                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                                <span class="text-xl font-bold">EM</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Emily Davis</div>
                                <div class="text-sm text-gray-400">Lead Developer, CodeCrafters</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"As a developer, I appreciate the clean API and the robust performance. This AI is a solid foundation for any modern application."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>

                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-pink-500 to-red-600 flex items-center justify-center">
                                <span class="text-xl font-bold">CH</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Chris Harris</div>
                                <div class="text-sm text-gray-400">Small Business Owner, Local Goods</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"Even the basic plan offers incredible value. It's helped me automate customer queries and save so much time."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>

                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-lime-500 to-green-600 flex items-center justify-center">
                                <span class="text-xl font-bold">LK</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">Linda Kim</div>
                                <div class="text-sm text-gray-400">Educator, Future Minds Academy</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"An invaluable tool for educational purposes. It helps students with research and understanding complex topics quickly."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>

                    <div class="review-card p-6 rounded-xl">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-r from-gray-500 to-gray-600 flex items-center justify-center">
                                <span class="text-xl font-bold">DP</span>
                            </div>
                            <div class="ml-4">
                                <div class="font-bold">David Perez</div>
                                <div class="text-sm text-gray-400">Freelance Writer</div>
                            </div>
                        </div>
                        <p class="text-gray-300">"The AI is a fantastic writing assistant. It helps overcome writer's block and generates creative ideas effortlessly."</p>
                        <div class="flex mt-4">
                            <span class="text-yellow-400">★★★★★</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Page -->
        <div id="pricing" class="page p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold mb-8 text-center gradient-text">Our Pricing Plans</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Basic Plan Card -->
                    <div class="review-card p-8 rounded-xl text-center">
                        <h2 class="text-3xl font-bold gradient-text mb-4">Basic Plan</h2>
                        <p class="text-gray-400 text-lg mb-6">Free</p>
                        <ul class="text-left text-gray-300 space-y-3 mb-8">
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>100 responses per day</span>
                            </li>
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>Normal response speed</span>
                            </li>
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>5 Notes Limit</span>
                            </li>
                        </ul>
                        <button class="w-full py-3 rounded-lg bg-gray-700 text-white font-bold hover:bg-gray-600 transition-all duration-300 cursor-not-allowed" disabled>
                            Current Plan
                        </button>
                    </div>

                    <!-- Pro Plan Card -->
                    <div class="review-card p-8 rounded-xl text-center border-2 border-purple-500">
                        <h2 class="text-3xl font-bold gradient-text mb-4">Pro Plan</h2>
                        <p class="text-gray-400 text-lg mb-6">$0<span class="text-sm text-gray-500">/month</span></p>
                        <ul class="text-left text-gray-300 space-y-3 mb-8">
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>Unlimited responses</span>
                            </li>
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>Prioritized response</span>
                            </li>
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>Prompt Templates</span>
                            </li>
                            <li class="flex items-center justify-center md:justify-start">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                <span>Unlimited Notes</span>
                            </li>
                        </ul>
                        <button onclick="showPaymentOptions()" class="w-full py-3 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold hover:from-purple-600 hover:to-indigo-700 transition-all duration-300">
                            Upgrade to Pro
                        </button>
                    </div>
                </div>

                <!-- Payment Options Modal -->
                <div id="payment-modal" class="modal">
                    <div class="modal-content">
                        <button onclick="hidePaymentOptions()" class="modal-close-button">&times;</button>
                        <h2 class="text-2xl font-bold gradient-text mb-6 text-center">Pro Model Under Maintanance</h2>
                        <div class="space-y-4">
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Page -->
        <div id="notes" class="page p-4 md:p-8">
            <div class="max-w-6xl mx-auto h-full">
                <h1 class="text-3xl md:text-4xl font-bold mb-8 text-center gradient-text">Notes</h1>
                
                <div id="notes-content" class="notes-container">
                    <!-- Notes Sidebar -->
                    <div class="notes-sidebar custom-scrollbar">
                        <div class="notes-sidebar-header">
                            <h2 class="text-xl font-bold">Notes List</h2>
                            <button onclick="createNewNote()" class="p-2 rounded-full bg-gradient-to-r from-purple-00 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 transition-all transform hover:scale-105">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                        <div id="notes-list" class="notes-list custom-scrollbar">
                            <!-- Notes will be loaded here -->
                        </div>
                    </div>

                    <!-- Notes Editor -->
                    <div class="notes-editor">
                        <input type="text" id="note-title" class="notes-editor-title" placeholder="Note Title">
                        <textarea id="note-content" class="notes-editor-content custom-scrollbar" placeholder="Start writing your note here..."></textarea>
                        <div class="notes-editor-actions">
                            <button onclick="saveCurrentNote()" class="notes-editor-save-btn">Save Note</button>
                        </div>
                    </div>
                </div>

                <div id="notes-no-user-message" class="notes-no-user-message hidden">
                    <p class="text-lg text-gray-300">Please sign in to access your notes.</p>
                </div>
            </div>
        </div>

        <!-- Connect Page -->
        <div id="connect" class="page p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold mb-8 text-center gradient-text">Connect with Others</h1>
                
                <div class="connect-container">
                    <!-- Community Groups Section -->
                    <div class="connect-section">
                        <h2>Community Groups</h2>
                        <div id="community-groups-list">
                            <!-- Dynamic group cards will be inserted here -->
                        </div>
                        <button onclick="showCreateGroupModal()" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold hover:from-purple-600 hover:to-indigo-700 transition-all duration-300 mt-4">
                            Create New Group
                        </button>
                    </div>

                    <!-- Find Friends Section -->
                    <div class="connect-section">
                        <h2>Find Friends</h2>
                        <input type="text" id="find-friend-input" class="friend-search-input" placeholder="Search by username...">
                        <button onclick="searchFriends()" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold hover:from-purple-600 hover:to-indigo-700 transition-all duration-300">
                            Search
                        </button>
                        <div id="friend-search-results" class="mt-4 space-y-2">
                            <!-- Search results will appear here -->
                            <p class="text-gray-400 text-center">Search for users to add as friends.</p>
                        </div>
                    </div>

                    <!-- Personal & Group Chats Section -->
                    <div class="connect-section">
                        <h2>Your Chats</h2>
                        <button onclick="showStartChatModal()" class="w-full py-2 rounded-lg bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold hover:from-purple-600 hover:to-indigo-700 transition-all duration-300 mb-4">
                            Start New Personal Chat
                        </button>
                        <div id="user-chats-list" class="space-y-2">
                            <!-- User's personal and group chats will be loaded here -->
                            <p class="text-gray-400 text-center">No active chats. Start one!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About Us Page -->
        <div id="about-us" class="page p-4 md:p-8">
            <div class="max-w-6xl mx-auto">
                <h1 class="text-3xl md:text-4xl font-bold mb-8 text-center gradient-text">About Xlence AI</h1>
                
                <div class="text-center text-lg text-gray-300 mb-12">
                    <p>Xlence AI is dedicated to empowering users with cutting-edge artificial intelligence solutions. We believe in creating smarter tools that enhance productivity, foster creativity, and connect communities.</p>
                </div>

                <div class="about-us-stats">
                    <div class="stat-card">
                        <h3>Total Accounts</h3>
                        <span class="number" id="accounts-count">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>Average Transaction Rating</h3>
                        <span class="stars" id="transaction-rating"></span>
                    </div>
                    <div class="stat-card">
                        <h3>Ecosystem Connections</h3>
                        <span class="number" id="ecosystem-count">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile" class="page p-4 md:p-8">
            <div class="profile-container">
                <h1 class="text-3xl md:text-4xl font-bold mb-8 text-center gradient-text">Your Profile</h1>
                
                <div class="profile-avatar-wrapper" onclick="document.getElementById('pfp-upload').click()">
                    <img id="profile-pfp" class="profile-avatar" src="" alt="Profile Picture">
                    <span id="profile-pfp-placeholder" class="profile-avatar-placeholder"></span>
                    <input type="file" id="pfp-upload" accept="image/*" class="hidden">
                    <div class="profile-avatar-edit-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </div>
                </div>

                <div class="profile-input-group">
                    <label for="profile-name">Name:</label>
                    <input type="text" id="profile-name" class="profile-input" placeholder="Your Name">
                </div>

                <div class="profile-input-group">
                    <label for="profile-bio">Bio:</label>
                    <textarea id="profile-bio" class="profile-textarea" placeholder="Tell us about yourself..."></textarea>
                </div>

                <div class="profile-input-group">
                    <label>Status:</label>
                    <div class="profile-status-options">
                        <button id="status-active" class="profile-status-button profile-status-active" data-status="active">Active</button>
                        <button id="status-idle" class="profile-status-button profile-status-idle" data-status="idle">Idle</button>
                        <button id="status-dnd" class="profile-status-button profile-status-dnd" data-status="dnd">Do Not Disturb</button>
                    </div>
                </div>

                <button id="profile-save-button" class="profile-save-button">Save Profile</button>
            </div>
        </div>
    </main>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <button onclick="hideAuthModal()" class="modal-close-button">&times;</button>
            <h2 id="auth-modal-title" class="text-2xl font-bold gradient-text mb-6 text-center">Sign In</h2>
            <div id="seed-phrase-section" class="hidden">
                <p class="text-center text-gray-300 mb-2">Your unique seed phrase:</p>
                <div id="generated-seed-phrase" class="seed-phrase-display mb-4"></div>
                <p class="text-center text-red-400 text-sm mb-4">Write this down! You cannot recover your account without it.</p>
            </div>
            <form id="auth-form">
                <input type="text" id="auth-username" placeholder="Username" class="modal-input" required>
                <input type="text" id="auth-nickname" placeholder="Nickname (e.g., AI Enthusiast)" class="modal-input hidden">
                <input type="text" id="auth-seed-phrase" placeholder="Enter your 6-word seed phrase (e.g., word1 word2 word3 word4 word5 word6)" class="modal-input hidden">
                <button type="submit" id="auth-submit-button" class="modal-submit-button">Sign In</button>
            </form>
            <p class="modal-switch-text">
                Don't have an account? <span onclick="switchAuthMode()">Sign Up</span>
            </p>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <button onclick="hideCreateGroupModal()" class="modal-close-button">&times;</button>
            <h2 class="text-2xl font-bold gradient-text mb-6 text-center">Create New Group</h2>
            <input type="text" id="new-group-name" placeholder="Group Name" class="modal-input" required>
            <textarea id="new-group-description" placeholder="Group Description (optional)" class="modal-input"></textarea>
            <button onclick="createGroup()" class="modal-submit-button">Create Group</button>
        </div>
    </div>

    <!-- Start Personal Chat Modal -->
    <div id="start-chat-modal" class="modal">
        <div class="modal-content">
            <button onclick="hideStartChatModal()" class="modal-close-button">&times;</button>
            <h2 class="text-2xl font-bold gradient-text mb-6 text-center">Start New Personal Chat</h2>
            <input type="text" id="chat-partner-username" placeholder="Enter username to chat with" class="modal-input" required>
            <button onclick="startPersonalChat()" class="modal-submit-button">Start Chat</button>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-notification">
        <span id="toast-message"></span>
    </div>

    <!-- Theme Switcher Button -->
    <button id="theme-switcher" class="theme-switcher">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M4 12H3m15.325 6.675l-.707.707M6.343 6.343l-.707-.707m12.728 0l-.707-.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
    </button>

    <script>
        // IMPORTANT: Replace with your actual Gemini API Key
        const GEMINI_API_KEY = "AIzaSyBkVuaLngxkMSluH84u-CgfU9YUauOPgbE"; 

        let currentPage = 'chat';
        let currentChatId = 1;
        let chatHistory = {}; // Stores chat history for the current session/user
        let chatCounter = 1;
        let isSignedIn = false; // Track user sign-in status
        let currentUsername = ''; // Store the logged-in username
        let currentNickname = ''; // Store the logged-in user's nickname
        let dailyResponseCount = 0;
        const MAX_DAILY_RESPONSES = 100; // Changed to 100 for basic plan
        const RESPONSE_LIMIT_KEY = 'ai_response_count';
        const LAST_RESPONSE_DATE_KEY = 'ai_last_response_date';
        const USERS_KEY = 'registered_users'; // Key for storing registered users
        const USER_CHAT_HISTORY_PREFIX = 'user_chat_history_'; // Prefix for user-specific chat history
        const USER_NOTES_PREFIX = 'user_notes_'; // Prefix for user-specific notes
        const USER_PROFILE_PREFIX = 'user_profile_'; // Prefix for user-specific profile data
        const COMMUNITY_GROUPS_KEY = 'community_groups'; // Key for storing community groups
        const USER_CONNECTIONS_PREFIX = 'user_connections_'; // Prefix for user's friends/chats

        let userNotes = {}; // Stores notes for the current logged-in user
        let currentNoteId = null; // ID of the currently active note in the editor
        let userConnections = {
            friends: [],
            personalChats: {}, // { 'otherUsername': { chatId: '...', messages: [] } }
            groupChats: {} // { 'groupId': { name: '...', members: [], messages: [] } }
        };

        // Notes limit for basic plan
        const BASIC_PLAN_NOTES_LIMIT = 5;
        // Flag to indicate if the user has a Pro plan (for notes and other features)
        let hasProPlan = false; // This would typically be determined by user data from a backend

        // List of words for seed phrase generation (example, expand as needed)
        const SEED_WORDS = [
            "apple", "baker", "brave", "build", "candy", "chair", "cloud", "coast", "crane", "daisy",
            "dance", "dream", "eagle", "earth", "ember", "fancy", "feast", "flame", "flick", "frost",
            "grape", "green", "happy", "house", "jolly", "jumps", "karma", "kites", "lemon", "light",
            "magic", "mango", "melon", "night", "ocean", "olive", "peace", "peach", "plant", "proud",
            "quick", "quiet", "river", "robot", "royal", "shine", "short", "shy", "smile", "spark",
            "stone", "storm", "sugar", "sunny", "sweet", "tiger", "toast", "train", "trust", "tulip",
            "unity", "urban", "vivid", "vowel", "wagon", "water", "whale", "windy", "world", "zebra"
        ];

        // --- Theme Switcher Logic ---
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            // Save user preference to localStorage
            if (document.body.classList.contains('light-mode')) {
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.setItem('theme', 'dark');
            }
        }

        // Apply saved theme on page load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            // Add event listener for the theme switcher button
            document.getElementById('theme-switcher').addEventListener('click', toggleTheme);
        });

        // --- Toast Notification Functions ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-container');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;
            toast.className = 'toast-notification show'; // Reset classes
            if (type === 'success') {
                toast.classList.add('success');
            } else if (type === 'error') {
                toast.classList.add('error');
            }

            setTimeout(() => {
                toast.classList.remove('show', 'success', 'error');
            }, 3000); // Hide after 3 seconds
        }

        // --- Authentication Logic ---
        let isSignInMode = true; // true for Sign In, false for Sign Up

        function generateSeedPhrase() {
            let phrase = [];
            let usedIndices = new Set();
            const allUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
            const existingSeedPhrases = new Set(Object.values(allUsers).map(user => user.seedPhrase));

            let attempts = 0;
            const numWords = 6; // Changed to 6 words
            while (phrase.length < numWords && attempts < 500) { // Increased attempts for 6 words
                const randomIndex = Math.floor(Math.random() * SEED_WORDS.length);
                const word = SEED_WORDS[randomIndex];
                if (!usedIndices.has(randomIndex)) {
                    phrase.push(word);
                    usedIndices.add(randomIndex);
                }
                if (phrase.length === numWords) {
                    const generatedCombination = phrase.join(' ');
                    if (existingSeedPhrases.has(generatedCombination)) {
                        phrase = [];
                        usedIndices = new Set();
                        attempts++;
                    }
                }
            }
            if (phrase.length < numWords) {
                console.error("Could not generate a unique 6-word seed phrase after many attempts.");
                return "error generating phrase"; 
            }
            return phrase.join(' ');
        }

        function showAuthModal(mode) {
            const authModal = document.getElementById('auth-modal');
            const authModalTitle = document.getElementById('auth-modal-title');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const switchTextContainer = authModal.querySelector('.modal-switch-text');
            const authUsernameInput = document.getElementById('auth-username');
            const authNicknameInput = document.getElementById('auth-nickname'); // Added nickname input
            const authSeedPhraseInput = document.getElementById('auth-seed-phrase');
            const seedPhraseSection = document.getElementById('seed-phrase-section');
            const generatedSeedPhraseDisplay = document.getElementById('generated-seed-phrase');

            isSignInMode = (mode === 'signin');
            if (isSignInMode) {
                authModalTitle.textContent = 'Sign In';
                authSubmitButton.textContent = 'Sign In';
                switchTextContainer.innerHTML = `Don't have an account? <span onclick="switchAuthMode()">Sign Up</span>`;
                authUsernameInput.placeholder = 'Username';
                authNicknameInput.classList.add('hidden'); // Hide nickname input for sign-in
                authSeedPhraseInput.classList.remove('hidden'); // Show seed phrase input for sign-in
                seedPhraseSection.classList.add('hidden'); // Hide generated seed phrase section
            } else {
                authModalTitle.textContent = 'Create Your Profile';
                authSubmitButton.textContent = 'Sign Up';
                switchTextContainer.innerHTML = `Already have an account? <span onclick="switchAuthMode()">Sign In</span>`;
                authUsernameInput.placeholder = 'Username (unique, max 12 chars, A-z, !@#$...)';
                authNicknameInput.classList.remove('hidden'); // Show nickname input for sign-up
                
                const newSeedPhrase = generateSeedPhrase();
                generatedSeedPhraseDisplay.textContent = newSeedPhrase;
                authSeedPhraseInput.classList.add('hidden'); // Hide seed phrase input for sign-up
                seedPhraseSection.classList.remove('hidden'); // Show generated seed phrase section
            }
            authModal.classList.add('show');
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.remove('show');
            document.getElementById('auth-username').value = '';
            document.getElementById('auth-nickname').value = ''; // Clear nickname input
            document.getElementById('auth-seed-phrase').value = '';
            document.getElementById('seed-phrase-section').classList.add('hidden'); // Ensure hidden on close
        }

        function switchAuthMode() {
            isSignInMode = !isSignInMode;
            showAuthModal(isSignInMode ? 'signin' : 'signup');
        }

        // Username validation function
        function isValidUsername(username) {
            if (username.length > 12) {
                return { valid: false, message: 'Username must be maximum 12 characters.' };
            }
            if (!/[A-Z]/.test(username)) {
                return { valid: false, message: 'Username must contain at least one uppercase letter.' };
            }
            if (!/[a-z]/.test(username)) {
                return { valid: false, message: 'Username must contain at least one lowercase letter.' };
            }
            if (!/[^a-zA-Z0-9]/.test(username)) { // Checks for any non-alphanumeric character
                return { valid: false, message: 'Username must contain at least one special character.' };
            }
            return { valid: true };
        }

        document.getElementById('auth-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('auth-username').value;
            const nickname = document.getElementById('auth-nickname').value; // Get nickname
            const seedPhrase = document.getElementById('auth-seed-phrase').value.trim().toLowerCase();
            let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');

            if (isSignInMode) {
                // Handle Sign In
                if (!username || !seedPhrase) {
                    showToast('Please fill in all fields.', 'error');
                    return;
                }

                if (users[username] && users[username].seedPhrase === seedPhrase) {
                    showToast('Sign In Successful!', 'success');
                    isSignedIn = true;
                    currentUsername = username;
                    currentNickname = users[username].nickname || username; // Use stored nickname or username
                    hasProPlan = users[username].plan === 'pro'; 

                    localStorage.setItem('isSignedIn', 'true');
                    localStorage.setItem('currentUsername', username);
                    localStorage.setItem('currentNickname', currentNickname); // Store nickname
                    loadUserChatHistory(username); // Load user-specific chat history
                    loadUserNotes(username); // Load user-specific notes
                    loadUserProfile(username); // Load user-specific profile
                    loadUserConnections(username); // Load user-specific connections
                    updateAuthUI();
                    hideAuthModal();
                    updateChatGreeting();
                    updateNotesUI(); // Update notes UI visibility
                    updateProfileUI(); // Update profile UI visibility
                    updateConnectUI(); // Update connect UI visibility
                } else {
                    showToast('Invalid username or seed phrase.', 'error');
                }
            } else {
                // Handle Sign Up
                const generatedSeedPhrase = document.getElementById('generated-seed-phrase').textContent;
                if (!username || !nickname) { // Nickname is now required for signup
                    showToast('Please fill in username and nickname.', 'error');
                    return;
                }

                const usernameValidation = isValidUsername(username);
                if (!usernameValidation.valid) {
                    showToast(usernameValidation.message, 'error');
                    return;
                }

                if (users[username]) {
                    showToast('Username already exists. Please choose a different username.', 'error');
                } else {
                    // New users default to basic plan, store nickname
                    users[username] = { seedPhrase: generatedSeedPhrase, plan: 'basic', nickname: nickname }; 
                    localStorage.setItem(USERS_KEY, JSON.stringify(users));
                    // Initialize default profile for new user
                    const defaultProfile = {
                        name: nickname,
                        pfp: 'https://via.placeholder.com/120x120?text=Anonymous', // Default anonymous PFP
                        bio: '',
                        status: 'active'
                    };
                    localStorage.setItem(USER_PROFILE_PREFIX + username, JSON.stringify(defaultProfile));
                    // Initialize empty connections for new user
                    localStorage.setItem(USER_CONNECTIONS_PREFIX + username, JSON.stringify({
                        friends: [],
                        personalChats: {},
                        groupChats: {}
                    }));

                    showToast('Account created! Please sign in with your new account and seed phrase.', 'success');
                    isSignInMode = true; // Switch to sign-in mode after successful sign-up
                    showAuthModal('signin');
                }
            }
        });

        function updateAuthUI() {
            const authButton = document.getElementById('auth-button');
            const responseLimitMessage = document.getElementById('response-limit-message');

            if (isSignedIn) {
                authButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                                        </svg><span>Sign Out</span>`;
                authButton.onclick = signOut;
                responseLimitMessage.classList.add('hidden');
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
            } else {
                authButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                                        </svg><span>Sign In</span>`;
                authButton.onclick = () => showAuthModal('signin');
                checkAndDisplayResponseLimit(); // Re-check limit if signed out
            }
        }

        function signOut() {
            // Save current user's chat history and notes before signing out
            saveUserChatHistory(currentUsername);
            saveUserNotes(currentUsername);
            saveUserProfile(currentUsername); // Save profile on sign out
            saveUserConnections(currentUsername); // Save connections on sign out

            isSignedIn = false;
            currentUsername = '';
            currentNickname = ''; // Clear nickname on sign out
            hasProPlan = false; // Reset pro plan status on sign out
            localStorage.removeItem('isSignedIn');
            localStorage.removeItem('currentUsername');
            localStorage.removeItem('currentNickname'); // Remove nickname from storage
            
            // Clear current chat history and notes from memory (but not from localStorage)
            chatHistory = {};
            userNotes = {};
            currentNoteId = null;
            userConnections = {
                friends: [],
                personalChats: {},
                groupChats: {}
            };

            // Re-initialize with a default chat for the "logged out" state
            currentChatId = 1;
            chatCounter = 1;
            chatHistory[currentChatId] = {
                id: currentChatId,
                title: "Chat 1",
                messages: [
                    {
                        content: "Hello! How can I help you today?",
                        isUser: false,
                        timestamp: new Date()
                    }
                ],
                created: new Date()
            };
            loadChatMessages(); // Display the default chat

            updateAuthUI();
            updateChatGreeting(); // Reset greeting
            updateNotesUI(); // Update notes UI visibility
            updateProfileUI(); // Update profile UI visibility
            updateConnectUI(); // Update connect UI visibility
            // Removed toast notification for sign out
        }

        // --- User-specific Chat History Management ---
        function saveUserChatHistory(username) {
            if (username && Object.keys(chatHistory).length > 0) {
                localStorage.setItem(USER_CHAT_HISTORY_PREFIX + username, JSON.stringify(chatHistory));
            }
        }

        function loadUserChatHistory(username) {
            const savedHistory = localStorage.getItem(USER_CHAT_HISTORY_PREFIX + username);
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                // Find the latest chat or default to the first one
                const chatIds = Object.keys(chatHistory);
                if (chatIds.length > 0) {
                    currentChatId = Math.max(...chatIds.map(id => parseInt(id)));
                    chatCounter = chatIds.length; // Adjust chatCounter based on loaded history
                } else {
                    // If history is empty for some reason, start a new default chat
                    currentChatId = 1;
                    chatCounter = 1;
                    chatHistory[currentChatId] = {
                        id: currentChatId,
                        title: "Chat 1",
                        messages: [
                            {
                                content: "Hello! How can I help you today?",
                                isUser: false,
                                timestamp: new Date()
                            }
                        ],
                        created: new Date()
                    };
                }
            } else {
                // No saved history for this user, start a fresh chat
                chatHistory = {};
                currentChatId = 1;
                chatCounter = 1;
                chatHistory[currentChatId] = {
                    id: currentChatId,
                    title: "Chat 1",
                    messages: [
                        {
                            content: "Hello! How can I help you today?",
                            isUser: false,
                            timestamp: new Date()
                        }
                    ],
                    created: new Date()
                };
            }
            loadChatMessages(); // Display the loaded/new chat
        }

        // --- AI Response Limit Logic ---
        function initializeResponseLimit() {
            const today = new Date().toDateString();
            const lastResponseDate = localStorage.getItem(LAST_RESPONSE_DATE_KEY);

            if (lastResponseDate !== today) {
                // New day, reset count
                dailyResponseCount = 0;
                localStorage.setItem(RESPONSE_LIMIT_KEY, 0);
                localStorage.setItem(LAST_RESPONSE_DATE_KEY, today);
            } else {
                dailyResponseCount = parseInt(localStorage.getItem(RESPONSE_LIMIT_KEY) || '0', 10);
            }
            checkAndDisplayResponseLimit();
        }

        function incrementResponseCount() {
            // Only increment if not signed in or if signed in but not a Pro user
            if (!isSignedIn || (isSignedIn && !hasProPlan)) {
                dailyResponseCount++;
                localStorage.setItem(RESPONSE_LIMIT_KEY, dailyResponseCount);
                localStorage.setItem(LAST_RESPONSE_DATE_KEY, new Date().toDateString());
                checkAndDisplayResponseLimit();
            }
        }

        function checkAndDisplayResponseLimit() {
            const limitMessage = document.getElementById('response-limit-message');
            // Limit applies only to non-signed-in users or basic plan users
            if (!isSignedIn || (isSignedIn && !hasProPlan)) {
                if (dailyResponseCount >= MAX_DAILY_RESPONSES) {
                    limitMessage.classList.remove('hidden');
                    document.getElementById('user-input').disabled = true;
                    document.getElementById('send-btn').disabled = true;
                } else {
                    limitMessage.classList.add('hidden');
                    document.getElementById('user-input').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                }
            } else {
                // Pro users have no response limit
                limitMessage.classList.add('hidden');
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
            }
        }

        // --- Chat Greeting Logic ---
        function updateChatGreeting() {
            const chatGreeting = document.getElementById('chat-greeting');
            if (isSignedIn && currentNickname) { // Use currentNickname for greeting
                const greetings = [`Hey ${currentNickname} Returns!`, `How Are You ${currentNickname}?`];
                const randomIndex = Math.floor(Math.random() * greetings.length);
                chatGreeting.textContent = greetings[randomIndex];
            } else {
                chatGreeting.textContent = 'Welcome!';
            }
        }

        // --- Existing Functions ---
        // Initial chat setup (moved to loadUserChatHistory for signed-in users)
        // For initial load when not signed in, it will use the default chatHistory setup.
        
        function switchPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Remove active class from all icon-only nav items
            document.querySelectorAll('.nav-item-icon-only').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active class to clicked nav item
            // Find the nav item that corresponds to the pageId
            const navItem = document.querySelector(`.nav-menu button[onclick="switchPage('${pageId}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            currentPage = pageId;
            
            // Animate team members when about page is shown
            if (pageId === 'about') {
                setTimeout(() => {
                    document.querySelectorAll('.team-member').forEach((member, index) => {
                        setTimeout(() => {
                            member.classList.add('visible');
                        }, index * 200);
                    });
                }, 100);
            }

            // Update notes UI when switching to notes page
            if (pageId === 'notes') {
                updateNotesUI();
            }

            // Trigger count animations when about-us page is shown
            if (pageId === 'about-us') {
                animateCounts();
            }

            // Update profile UI when switching to profile page
            if (pageId === 'profile') {
                updateProfileUI();
            }

            // Update connect UI when switching to connect page
            if (pageId === 'connect') {
                updateConnectUI();
            }
        }
        
        function toggleChatDropdown() {
            const dropdown = document.getElementById('chat-dropdown');
            const arrow = document.getElementById('dropdown-arrow');
            const isVisible = dropdown.classList.contains('opacity-100');
            
            if (isVisible) {
                dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
                dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                dropdown.classList.remove('opacity-0', 'invisible', 'scale-100');
                dropdown.classList.add('opacity-100', 'visible', 'scale-100');
                arrow.style.transform = 'rotate(180deg)';
                updateChatHistoryList();
            }
        }
        
        function startNewChat() {
            // Save current chat before creating a new one
            if (isSignedIn && currentUsername) {
                saveUserChatHistory(currentUsername);
            }
            
            // Create new chat
            chatCounter++;
            currentChatId = Date.now(); // Use timestamp as unique ID
            chatHistory[currentChatId] = {
                id: currentChatId,
                title: `Chat ${chatCounter}`,
                messages: [
                    {
                        content: "Hello! How can I help you today?",
                        isUser: false,
                        timestamp: new Date()
                    }
                ],
                created: new Date()
                };
            
            // Clear and reload messages
            loadChatMessages();
            toggleChatDropdown();
        }
        
        function loadChat(chatId) {
            // Save current chat before switching
            if (isSignedIn && currentUsername) {
                saveUserChatHistory(currentUsername);
            }
            
            // Switch to selected chat
            currentChatId = chatId;
            loadChatMessages();
            toggleChatDropdown();
        }
        
        function saveChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            const messages = [];
            
            messagesContainer.querySelectorAll('.message').forEach(messageEl => {
                const isUser = messageEl.classList.contains('user-message');
                // Extract content, preserving HTML for formatting
                const content = messageEl.querySelector('p').innerHTML; 
                messages.push({
                    content: content,
                    isUser: isUser,
                    timestamp: new Date()
                });
            });
            
            if (chatHistory[currentChatId]) {
                chatHistory[currentChatId].messages = messages;
                
                // Update title based on first user message (use textContent for title)
                const firstUserMessage = messages.find(m => m.isUser);
                if (firstUserMessage) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = firstUserMessage.content;
                    const titleText = tempDiv.textContent || tempDiv.innerText || '';

                    const title = titleText.length > 30 
                        ? titleText.substring(0, 30) + ''
                        : titleText;
                    chatHistory[currentChatId].title = title;
                }
            }
        }
        
        function loadChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            if (chatHistory[currentChatId]) {
                chatHistory[currentChatId].messages.forEach(message => {
                    addMessageToDOM(message.content, message.isUser);
                });
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom after loading
        }
        
        function updateChatHistoryList() {
            const historyList = document.getElementById('chat-history-list');
            historyList.innerHTML = '';
            
            // Sort chats by creation date (newest first)
            const sortedChats = Object.values(chatHistory).sort((a, b) => new Date(b.created) - new Date(a.created));
            
            if (sortedChats.length === 0) {
                historyList.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">No chat history</div>';
                return;
            }
            
            sortedChats.forEach(chat => {
                const chatItem = document.createElement('button');
                chatItem.className = `w-full flex items-start space-x-3 px-3 py-2 text-left hover:bg-gray-700 rounded-lg transition-all duration-200 ${chat.id === currentChatId ? 'bg-gray-700' : ''}`;
                chatItem.onclick = () => loadChat(chat.id);
                
                const timeAgo = getTimeAgo(chat.created);
                
                chatItem.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-1 text-gray-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-white truncate">${chat.title}</div>
                        <div class="text-xs text-gray-400">${timeAgo}</div>
                    </div>
                    ${chat.id === currentChatId ? `
                        <div class="w-2 h-2 bg-green-400 rounded-full flex-shrink-0"></div>
                    ` : ''}
                `;
                
                historyList.appendChild(chatItem);
            });
        }
        
        function clearChatHistory() {
            if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
                chatHistory = {};
                startNewChat(); // This will create a new chat and effectively clear the current view
                if (isSignedIn && currentUsername) {
                    localStorage.removeItem(USER_CHAT_HISTORY_PREFIX + currentUsername); // Also clear from storage
                }
                updateChatHistoryList();
                // Removed toast notification for clearing chat history
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - new Date(date)) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}h ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays}d ago`;
            
            return new Date(date).toLocaleDateString();
        }
        
        function addMessage(content, isUser = false) {
            // Save message to current chat
            if (!chatHistory[currentChatId]) {
                chatHistory[currentChatId] = {
                    id: currentChatId,
                    title: isUser ? (content.length > 30 ? content.substring(0, 30) + '' : content) : `Chat ${chatCounter}`,
                    messages: [],
                    created: new Date()
                };
            }
            
            // Only add user messages to history here. AI messages are added after typing animation.
            if (isUser) {
                chatHistory[currentChatId].messages.push({
                    content: content,
                    isUser: isUser,
                    timestamp: new Date()
                });
            }
            
            // Update title if this is the first user message
            if (isUser && chatHistory[currentChatId].messages.filter(m => m.isUser).length === 1) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const titleText = tempDiv.textContent || tempDiv.innerText || '';

                chatHistory[currentChatId].title = titleText.length > 30 ? titleText.substring(0, 30) + '' : titleText;
            }
            
            addMessageToDOM(content, isUser);
        }
        
        function addMessageToDOM(content, isUser = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message message' : 'ai-message message';
            
            if (isUser) {
                // Removed "You" text
                messageDiv.innerHTML = `<div class="font-medium mb-1"></div><p>${content}</p>`;
            } else {
                // Removed "Xlence AI" text
                messageDiv.innerHTML = `<div class="font-medium mb-1 gradient-text"></div><p>${formatAIResponse(content)}</p>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to format AI response for display
        function formatAIResponse(text) {
            // Replace **text** with <strong>text</strong>
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Replace * text with <ul><li> text (simple bullet points)
            // This is a basic implementation and might need more robust parsing for complex markdown lists
            text = text.replace(/^\s*\*\s*(.*)/gm, '<li>$1</li>');
            if (text.includes('<li>')) {
                text = `<ul>${text}</ul>`;
            }

            // Replace 1. text with <ol><li> text (simple numbered lists)
            text = text.replace(/^\s*\d+\.\s*(.*)/gm, '<li>$1</li>');
            if (text.includes('<li>') && !text.startsWith('<ul>')) { // Avoid nesting if already a bullet list
                text = `<ol>${text}</ol>`;
            }

            // Handle newlines for paragraphs if not part of a list
            if (!text.startsWith('<ul') && !text.startsWith('<ol')) {
                text = text.replace(/\n/g, '<br>');
            }
            
            return text;
        }
        
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            // Removed "Xlence AI" text
            typingDiv.innerHTML = `
                <div class="font-medium mb-1 gradient-text"></div>
                <div class="flex space-x-1">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Function to simulate typing out the AI response letter by letter
        function typeMessage(htmlContent, callback) { // Now accepts HTML content
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message message';
            // Removed "Xlence AI" text
            messageDiv.innerHTML = `<div class="font-medium mb-1 gradient-text"></div><p></p>`;
            messagesContainer.appendChild(messageDiv);

            const paragraph = messageDiv.querySelector('p');
            let i = 0;
            const speed = 20; // Typing speed in milliseconds per character

            // Create a temporary div to parse the HTML content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const nodes = Array.from(tempDiv.childNodes); // Get all child nodes (text, strong, ul, li, br)

            function typeNode(nodeIndex, charIndex) {
                if (nodeIndex < nodes.length) {
                    const currentNode = nodes[nodeIndex];

                    if (currentNode.nodeType === Node.TEXT_NODE) { // Text node
                        if (charIndex < currentNode.textContent.length) {
                            paragraph.innerHTML += currentNode.textContent.charAt(charIndex);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            setTimeout(() => typeNode(nodeIndex, charIndex + 1), speed);
                        } else {
                            // Move to next node
                            typeNode(nodeIndex + 1, 0);
                        }
                    } else if (currentNode.nodeType === Node.ELEMENT_NODE) { // Element node (e.g., strong, ul, li, br)
                        // Append the entire element's outerHTML
                        paragraph.innerHTML += currentNode.outerHTML;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        // Move to next node
                        typeNode(nodeIndex + 1, 0);
                    } else {
                        // Skip other node types (comments, etc.)
                        typeNode(nodeIndex + 1, 0);
                    }
                } else {
                    // All nodes typed, call the callback
                    if (callback) {
                        callback();
                    }
                }
            }
            typeNode(0, 0); // Start typing from the first node
        }
        
 // Function to call Gemini API
 async function getGeminiResponse(userMessage) {
    const conversation = chatHistory[currentChatId].messages.map(msg => ({
        role: msg.isUser ? 'user' : 'model',
        parts: [{ text: msg.content }]
    }));

    // Add the latest user message to the conversation
    conversation.push({ role: 'user', parts: [{ text: userMessage }] });

    // CORRECT GEMINI API ENDPOINT (replace with the actual one if different)
    // This is a common endpoint structure for Google's Generative AI APIs
    const GEMINI_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

    try {
        const response = await fetch(GEMINI_API_ENDPOINT, { // Use the correct API endpoint here
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: conversation // Gemini API expects 'contents' for the conversation history
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error.message}`);
        }

        const data = await response.json();
        // The response structure for Gemini API might be different.
        // You'll likely find the generated text in data.candidates[0].content.parts[0].text
        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
            return data.candidates[0].content.parts[0].text;
        } else {
            return "No response generated by AI.";
        }
    } catch (error) {
        console.error("Error calling backend Gemini API:", error);
        return `Error: ${error.message}. Please check backend connection or API key.`;
    }
}


       
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const userMessage = input.value.trim();
            
            if (!userMessage) return; // Don't send empty messages

            // Check response limit before sending message
            if (!isSignedIn || (isSignedIn && !hasProPlan)) { // Apply limit to basic plan users
                if (dailyResponseCount >= MAX_DAILY_RESPONSES) {
                    checkAndDisplayResponseLimit(); // Ensure message is shown
                    return;
                }
            }
            
            addMessage(userMessage, true);
            input.value = '';
            
            // Disable send button and input field
            document.getElementById('send-btn').disabled = true;
            document.getElementById('user-input').disabled = true;

            // Show typing indicator
            showTypingIndicator();
            
            try {
                const aiResponse = await getGeminiResponse(userMessage);
                removeTypingIndicator(); // Remove indicator before starting typing animation

                // Format the AI response to HTML BEFORE passing it to typeMessage
                const formattedAiResponse = formatAIResponse(aiResponse);

                // Use the new typeMessage function for animated typing
                typeMessage(formattedAiResponse, () => {
                    // This callback runs when the typing animation is complete
                    // Add the full message to chatHistory after typing is done
                    if (!chatHistory[currentChatId]) {
                        chatHistory[currentChatId] = {
                            id: currentChatId,
                            title: userMessage.length > 30 ? userMessage.substring(0, 30) + '' : userMessage,
                            messages: [],
                            created: new Date()
                        };
                    }
                    chatHistory[currentChatId].messages.push({
                        content: aiResponse, // Store original AI response for history/re-formatting
                        isUser: false,
                        timestamp: new Date()
                    });

                    incrementResponseCount(); // Increment count after AI responds (only for basic plan)
                    // Save chat history after each message if signed in
                    if (isSignedIn && currentUsername) {
                        saveUserChatHistory(currentUsername);
                    }

                    // Re-enable send button and input field
                    document.getElementById('send-btn').disabled = false;
                    document.getElementById('user-input').disabled = false;
                    document.getElementById('user-input').focus(); // Focus back on input
                });

            } catch (error) {
                console.error("Failed to get AI response:", error);
                removeTypingIndicator();
                addMessage("Oops! Something went wrong while getting a response from the AI. Please try again later.", false);

                // Re-enable send button and input field even on error
                document.getElementById('send-btn').disabled = false;
                document.getElementById('user-input').disabled = false;
                document.getElementById('user-input').focus();
            }
        }
        
        // Event listeners
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Chat dropdown event listener
        document.getElementById('chat-dropdown-btn').addEventListener('click', toggleChatDropdown);
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('chat-dropdown');
            const dropdownBtn = document.getElementById('chat-dropdown-btn');
            
            if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
                dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
                document.getElementById('dropdown-arrow').style.transform = 'rotate(0deg)';
            }
        });

        // Payment Modal Functions
        function showPaymentOptions() {
            document.getElementById('payment-modal').classList.add('show');
        }

        function hidePaymentOptions() {
            document.getElementById('payment-modal').classList.remove('show');
        }

        function processPayment(method) {
            showToast(`Initiating payment with ${method.toUpperCase()}. (This is a placeholder.)`, 'info');
            hidePaymentOptions();
            // In a real application, you would redirect to Stripe checkout,
            // display a QRIS code, or interact with a payment gateway API.
            // After successful payment, you would update the user's plan to 'pro'
            // For demonstration, let's simulate a successful upgrade:
            if (isSignedIn && currentUsername) {
                let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
                if (users[currentUsername]) {
                    users[currentUsername].plan = 'pro';
                    localStorage.setItem(USERS_KEY, JSON.stringify(users));
                    hasProPlan = true; // Update in-memory flag
                    showToast('Upgrade successful! You now have Pro features.', 'success');
                    updateAuthUI(); // Re-evaluate response limit
                    updateNotesUI(); // Re-evaluate notes limit
                }
            }
        }

        // --- Notes Specific Functions ---
        function updateNotesUI() {
            const notesContent = document.getElementById('notes-content');
            const noUserMessage = document.getElementById('notes-no-user-message');
            const noteTitleInput = document.getElementById('note-title');
            const noteContentInput = document.getElementById('note-content');

            if (isSignedIn && currentUsername) {
                notesContent.classList.remove('hidden');
                noUserMessage.classList.add('hidden');
                loadNotesList(); // Load notes for the signed-in user
                // Clear editor when notes page is opened or user signs in
                noteTitleInput.value = '';
                noteContentInput.value = '';
                currentNoteId = null;
            } else {
                notesContent.classList.add('hidden');
                noUserMessage.classList.remove('hidden');
            }
        }

        function saveUserNotes(username) {
            if (username) {
                localStorage.setItem(USER_NOTES_PREFIX + username, JSON.stringify(userNotes));
            }
        }

        function loadUserNotes(username) {
            const savedNotes = localStorage.getItem(USER_NOTES_PREFIX + username);
            if (savedNotes) {
                userNotes = JSON.parse(savedNotes);
            } else {
                userNotes = {}; // Initialize empty if no notes found
            }
            loadNotesList(); // Update the sidebar list
        }

        function loadNotesList() {
            const notesListDiv = document.getElementById('notes-list');
            notesListDiv.innerHTML = ''; // Clear existing list

            const sortedNoteIds = Object.keys(userNotes).sort((a, b) => {
                return new Date(userNotes[b].lastModified) - new Date(userNotes[a].lastModified);
            });

            if (sortedNoteIds.length === 0) {
                notesListDiv.innerHTML = '<p class="text-gray-500 text-center mt-4">No notes yet. Click "+" to create one!</p>';
                return;
            }

            sortedNoteIds.forEach(noteId => {
                const note = userNotes[noteId];
                const listItem = document.createElement('div');
                listItem.className = `notes-list-item ${noteId === currentNoteId ? 'active' : ''}`;
                listItem.setAttribute('data-note-id', noteId);
                listItem.innerHTML = `
                    <span class="notes-list-item-title">${note.title || 'Untitled Note'}</span>
                    <button class="notes-delete-btn" onclick="deleteNote(event, '${noteId}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                listItem.onclick = (event) => {
                    // Only load note if click is not on delete button
                    if (!event.target.closest('.notes-delete-btn')) {
                        loadNote(noteId);
                    }
                };
                notesListDiv.appendChild(listItem);
            });
        }

        function createNewNote() {
            // Check notes limit for basic plan users
            if (isSignedIn && !hasProPlan && Object.keys(userNotes).length >= BASIC_PLAN_NOTES_LIMIT) {
                showToast(`You have reached the limit of ${BASIC_PLAN_NOTES_LIMIT} notes for the Basic Plan. Please delete an existing note or upgrade to Pro for unlimited notes.`, 'error');
                return;
            }

            // Save current note if one is active
            if (currentNoteId) {
                saveCurrentNote();
            }

            const newNoteId = Date.now().toString();
            userNotes[newNoteId] = {
                id: newNoteId,
                title: 'Untitled Note',
                content: '',
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            currentNoteId = newNoteId;
            document.getElementById('note-title').value = userNotes[newNoteId].title;
            document.getElementById('note-content').value = userNotes[newNoteId].content;
            
            saveUserNotes(currentUsername);
            loadNotesList(); // Refresh list to show new note
            // Removed toast notification for new note creation
        }

        function loadNote(noteId) {
            // Save current note before loading a new one
            if (currentNoteId && currentNoteId !== noteId) {
                saveCurrentNote();
            }

            const note = userNotes[noteId];
            if (note) {
                currentNoteId = noteId;
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-content').value = note.content;
                loadNotesList(); // Update active state in list
            } else {
                showToast('Note not found!', 'error');
            }
        }

        function saveCurrentNote() {
            if (!currentNoteId) {
                showToast('No note selected to save.', 'info');
                return;
            }

            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value;

            if (userNotes[currentNoteId]) {
                userNotes[currentNoteId].title = title || 'Untitled Note';
                userNotes[currentNoteId].content = content;
                userNotes[currentNoteId].lastModified = new Date().toISOString();
                saveUserNotes(currentUsername);
                loadNotesList(); // Refresh list to update title/last modified
                showToast('Note saved!', 'success');
            } else {
                showToast('Error: Cannot save note. It might have been deleted.', 'error');
            }
        }

        function deleteNote(event, noteId) {
            event.stopPropagation(); // Prevent triggering loadNote
            if (confirm('Are you sure you want to delete this note?')) {
                if (userNotes[noteId]) {
                    delete userNotes[noteId];
                    saveUserNotes(currentUsername);
                    // Removed toast notification for note deletion

                    if (currentNoteId === noteId) {
                        // If the deleted note was open, clear the editor
                        document.getElementById('note-title').value = '';
                        document.getElementById('note-content').value = '';
                        currentNoteId = null;
                    }
                    loadNotesList(); // Refresh the list
                } else {
                    showToast('Note not found for deletion.', 'error');
                }
            }
        }

        // --- Profile Page Functions ---
        function updateProfileUI() {
            const profilePage = document.getElementById('profile');
            if (isSignedIn && currentUsername) {
                profilePage.classList.remove('hidden');
                loadUserProfile(currentUsername);
            } else {
                profilePage.classList.add('hidden');
                // Optionally, redirect to sign-in or show a message
                // switchPage('chat'); // Example: redirect to chat if not signed in
                // showToast('Please sign in to view your profile.', 'info');
            }
        }

        function loadUserProfile(username) {
            const savedProfile = localStorage.getItem(USER_PROFILE_PREFIX + username);
            let profileData = savedProfile ? JSON.parse(savedProfile) : {
                name: currentNickname, // Default name to nickname
                pfp: 'https://via.placeholder.com/120x120?text=Anonymous', // Default anonymous PFP
                bio: '',
                status: 'active'
            };

            document.getElementById('profile-name').value = profileData.name;
            document.getElementById('profile-bio').value = profileData.bio;
            updateProfilePicture(profileData.pfp);
            updateProfileStatus(profileData.status);
        }

        function saveUserProfile(username) {
            const profileData = {
                name: document.getElementById('profile-name').value,
                pfp: document.getElementById('profile-pfp').src,
                bio: document.getElementById('profile-bio').value,
                status: document.querySelector('.profile-status-button.active')?.dataset.status || 'active'
            };
            localStorage.setItem(USER_PROFILE_PREFIX + username, JSON.stringify(profileData));
            showToast('Profile saved successfully!', 'success');
        }

        function updateProfilePicture(imageDataUrl) {
            const pfpImg = document.getElementById('profile-pfp');
            const pfpPlaceholder = document.getElementById('profile-pfp-placeholder');

            if (imageDataUrl && imageDataUrl !== 'https://via.placeholder.com/120x120?text=Anonymous') { // Check if it's a valid image data URL
                pfpImg.src = imageDataUrl;
                pfpImg.classList.remove('hidden');
                pfpPlaceholder.classList.add('hidden');
            } else {
                pfpImg.src = 'https://via.placeholder.com/120x120?text=Anonymous'; // Set to anonymous PFP
                pfpImg.classList.remove('hidden'); // Ensure image is shown
                pfpPlaceholder.classList.add('hidden'); // Hide placeholder
            }
        }

        function updateProfileStatus(status) {
            document.querySelectorAll('.profile-status-button').forEach(button => {
                button.classList.remove('active');
            });
            const activeButton = document.querySelector(`.profile-status-button[data-status="${status}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // Event listener for PFP upload
        document.getElementById('pfp-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateProfilePicture(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Event listeners for status buttons
        document.querySelectorAll('.profile-status-button').forEach(button => {
            button.addEventListener('click', function() {
                updateProfileStatus(this.dataset.status);
            });
        });

        // Event listener for save profile button
        document.getElementById('profile-save-button').addEventListener('click', function() {
            if (isSignedIn && currentUsername) {
                saveUserProfile(currentUsername);
            } else {
                showToast('Please sign in to save your profile.', 'error');
            }
        });

        // --- About Us Page Animations ---
        function animateCount(elementId, start, end, duration) {
            const element = document.getElementById(elementId);
            let startTime = null;

            function easeOutQuad(t) {
                return t * (2 - t);
            }

            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const progress = Math.min((currentTime - startTime) / duration, 1);
                const easedProgress = easeOutQuad(progress);
                const currentValue = Math.floor(easedProgress * (end - start) + start);
                element.textContent = currentValue.toLocaleString(); // Add comma separators
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            requestAnimationFrame(animate);
        }

        function generateRandomStars() {
            const rating = (Math.random() * (5 - 3.5) + 3.5).toFixed(1); // Random rating between 3.5 and 5.0
            let stars = '';
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                stars += '★';
            }
            if (halfStar) {
                stars += '☆'; // Using an empty star for half, or you could use a half-star character if available
            }
            return stars;
        }

        function animateCounts() {
            // Accounts Count
            const totalAccounts = Math.floor(Math.random() * (10000 - 5000 + 1)) + 5000; // Random between 5000 and 10000
            animateCount('accounts-count', 0, totalAccounts, 2000);

            // Transaction Rate
            document.getElementById('transaction-rating').textContent = generateRandomStars();

            // Ecosystem Connections
            const totalEcosystems = Math.floor(Math.random() * (500 - 100 + 1)) + 100; // Random between 100 and 500
            animateCount('ecosystem-count', 0, totalEcosystems, 2000);
        }

        // --- Connect Page Functions ---
        function updateConnectUI() {
            if (!isSignedIn) {
                document.getElementById('community-groups-list').innerHTML = '<p class="text-gray-400 text-center">Please sign in to view community groups.</p>';
                document.getElementById('friend-search-results').innerHTML = '<p class="text-gray-400 text-center">Please sign in to find friends.</p>';
                document.getElementById('user-chats-list').innerHTML = '<p class="text-gray-400 text-center">Please sign in to view your chats.</p>';
                document.querySelector('#connect .connect-section button').disabled = true; // Disable create group button
                document.querySelector('#connect .friend-search-input').disabled = true; // Disable search input
                document.querySelector('#connect .connect-section button:nth-of-type(2)').disabled = true; // Disable search button
                document.querySelector('#connect .connect-section:nth-of-type(3) button').disabled = true; // Disable start new chat button
                return;
            } else {
                document.querySelector('#connect .connect-section button').disabled = false;
                document.querySelector('#connect .friend-search-input').disabled = false;
                document.querySelector('#connect .connect-section button:nth-of-type(2)').disabled = false;
                document.querySelector('#connect .connect-section:nth-of-type(3) button').disabled = false;
            }

            loadCommunityGroups();
            loadUserChats();
        }

        function saveUserConnections(username) {
            if (username) {
                localStorage.setItem(USER_CONNECTIONS_PREFIX + username, JSON.stringify(userConnections));
            }
        }

        function loadUserConnections(username) {
            const savedConnections = localStorage.getItem(USER_CONNECTIONS_PREFIX + username);
            if (savedConnections) {
                userConnections = JSON.parse(savedConnections);
            } else {
                userConnections = {
                    friends: [],
                    personalChats: {},
                    groupChats: {}
                };
            }
            updateConnectUI();
        }

        // Community Groups
        function loadCommunityGroups() {
            const groupsListDiv = document.getElementById('community-groups-list');
            groupsListDiv.innerHTML = ''; // Clear existing list

            let allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');

            if (Object.keys(allGroups).length === 0) {
                groupsListDiv.innerHTML = '<p class="text-gray-400 text-center">No community groups available. Be the first to create one!</p>';
                return;
            }

            for (const groupId in allGroups) {
                const group = allGroups[groupId];
                const isMember = group.members.includes(currentUsername);
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                groupCard.innerHTML = `
                    <div>
                        <div class="font-bold">${group.name}</div>
                        <div class="text-sm text-gray-400">${group.description || 'No description.'}</div>
                        <div class="text-xs text-gray-500">${group.members.length} members</div>
                    </div>
                    <button onclick="${isMember ? `leaveGroup('${groupId}')` : `joinGroup('${groupId}')`}">
                        ${isMember ? 'Leave' : 'Join'}
                    </button>
                `;
                groupsListDiv.appendChild(groupCard);
            }
        }

        function showCreateGroupModal() {
            if (!isSignedIn) {
                showToast('Please sign in to create a group.', 'error');
                return;
            }
            document.getElementById('create-group-modal').classList.add('show');
            document.getElementById('new-group-name').value = '';
            document.getElementById('new-group-description').value = '';
        }

        function hideCreateGroupModal() {
            document.getElementById('create-group-modal').classList.remove('show');
        }

        function createGroup() {
            const groupName = document.getElementById('new-group-name').value.trim();
            const groupDescription = document.getElementById('new-group-description').value.trim();

            if (!groupName) {
                showToast('Group name cannot be empty.', 'error');
                return;
            }

            let allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');
            const groupId = Date.now().toString(); // Simple unique ID

            allGroups[groupId] = {
                id: groupId,
                name: groupName,
                description: groupDescription,
                members: [currentUsername],
                createdAt: new Date().toISOString(),
                messages: [] // Store group chat messages here
            };
            localStorage.setItem(COMMUNITY_GROUPS_KEY, JSON.stringify(allGroups));

            // Add to user's group chats
            userConnections.groupChats[groupId] = {
                name: groupName,
                members: [currentUsername],
                chatId: groupId // Reference to the group's message history
            };
            saveUserConnections(currentUsername);

            showToast(`Group "${groupName}" created and you've joined!`, 'success');
            hideCreateGroupModal();
            loadCommunityGroups(); // Refresh the list
            loadUserChats(); // Refresh user's chat list
        }

        function joinGroup(groupId) {
            if (!isSignedIn) {
                showToast('Please sign in to join a group.', 'error');
                return;
            }

            let allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');
            if (allGroups[groupId]) {
                if (!allGroups[groupId].members.includes(currentUsername)) {
                    allGroups[groupId].members.push(currentUsername);
                    localStorage.setItem(COMMUNITY_GROUPS_KEY, JSON.stringify(allGroups));

                    userConnections.groupChats[groupId] = {
                        name: allGroups[groupId].name,
                        members: allGroups[groupId].members,
                        chatId: groupId
                    };
                    saveUserConnections(currentUsername);

                    showToast(`Joined group "${allGroups[groupId].name}"!`, 'success');
                    loadCommunityGroups();
                    loadUserChats();
                } else {
                    showToast('You are already a member of this group.', 'info');
                }
            } else {
                showToast('Group not found.', 'error');
            }
        }

        function leaveGroup(groupId) {
            if (!isSignedIn) {
                showToast('Please sign in to leave a group.', 'error');
                return;
            }

            if (confirm('Are you sure you want to leave this group?')) {
                let allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');
                if (allGroups[groupId]) {
                    allGroups[groupId].members = allGroups[groupId].members.filter(member => member !== currentUsername);
                    localStorage.setItem(COMMUNITY_GROUPS_KEY, JSON.stringify(allGroups));

                    delete userConnections.groupChats[groupId];
                    saveUserConnections(currentUsername);

                    showToast(`Left group "${allGroups[groupId].name}".`, 'info');
                    loadCommunityGroups();
                    loadUserChats();
                } else {
                    showToast('Group not found.', 'error');
                }
            }
        }

        // Find Friends
        function searchFriends() {
            if (!isSignedIn) {
                showToast('Please sign in to search for friends.', 'error');
                return;
            }

            const searchTerm = document.getElementById('find-friend-input').value.trim().toLowerCase();
            const searchResultsDiv = document.getElementById('friend-search-results');
            searchResultsDiv.innerHTML = '';

            if (!searchTerm) {
                searchResultsDiv.innerHTML = '<p class="text-gray-400 text-center">Search for users to add as friends.</p>';
                return;
            }

            const allUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
            let foundUsers = [];

            for (const username in allUsers) {
                if (username.toLowerCase().includes(searchTerm) && username !== currentUsername) {
                    foundUsers.push({ username: username, nickname: allUsers[username].nickname });
                }
            }

            if (foundUsers.length === 0) {
                searchResultsDiv.innerHTML = '<p class="text-gray-400 text-center">No users found matching your search.</p>';
                return;
            }

            foundUsers.forEach(user => {
                const isFriend = userConnections.friends.includes(user.username);
                const resultCard = document.createElement('div');
                resultCard.className = 'group-card'; // Reusing group-card style
                resultCard.innerHTML = `
                    <div>
                        <div class="font-bold">${user.nickname} (${user.username})</div>
                    </div>
                    <button onclick="${isFriend ? `removeFriend('${user.username}')` : `addFriend('${user.username}')`}">
                        ${isFriend ? 'Remove Friend' : 'Add Friend'}
                    </button>
                `;
                searchResultsDiv.appendChild(resultCard);
            });
        }

        function addFriend(friendUsername) {
            if (!isSignedIn) {
                showToast('Please sign in to add friends.', 'error');
                return;
            }
            if (userConnections.friends.includes(friendUsername)) {
                showToast(`${friendUsername} is already your friend.`, 'info');
                return;
            }

            userConnections.friends.push(friendUsername);
            saveUserConnections(currentUsername);
            showToast(`${friendUsername} added to your friends list!`, 'success');
            searchFriends(); // Refresh search results
        }

        function removeFriend(friendUsername) {
            if (!isSignedIn) {
                showToast('Please sign in to remove friends.', 'error');
                return;
            }
            if (confirm(`Are you sure you want to remove ${friendUsername} from your friends?`)) {
                userConnections.friends = userConnections.friends.filter(f => f !== friendUsername);
                saveUserConnections(currentUsername);
                showToast(`${friendUsername} removed from your friends list.`, 'info');
                searchFriends(); // Refresh search results
            }
        }

        // Personal & Group Chats
        function loadUserChats() {
            const userChatsListDiv = document.getElementById('user-chats-list');
            userChatsListDiv.innerHTML = '';

            const allUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');

            let hasChats = false;

            // Load Personal Chats
            for (const partnerUsername in userConnections.personalChats) {
                hasChats = true;
                const chatInfo = userConnections.personalChats[partnerUsername];
                const partnerNickname = allUsers[partnerUsername]?.nickname || partnerUsername;
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-list-item';
                chatItem.onclick = () => openPersonalChat(partnerUsername);
                chatItem.innerHTML = `
                    <div class="chat-avatar">${partnerNickname.charAt(0).toUpperCase()}</div>
                    <div>
                        <div class="font-bold">${partnerNickname} (Personal)</div>
                        <div class="text-sm text-gray-400">${chatInfo.lastMessage || 'No messages yet.'}</div>
                    </div>
                `;
                userChatsListDiv.appendChild(chatItem);
            }

            // Load Group Chats
            for (const groupId in userConnections.groupChats) {
                hasChats = true;
                const groupInfo = userConnections.groupChats[groupId];
                const allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');
                const groupData = allGroups[groupId];
                const lastMessage = groupData?.messages.length > 0 ? groupData.messages[groupData.messages.length - 1].content : 'No messages yet.';

                const chatItem = document.createElement('div');
                chatItem.className = 'chat-list-item';
                chatItem.onclick = () => openGroupChat(groupId);
                chatItem.innerHTML = `
                    <div class="chat-avatar">${groupInfo.name.charAt(0).toUpperCase()}</div>
                    <div>
                        <div class="font-bold">${groupInfo.name} (Group)</div>
                        <div class="text-sm text-gray-400">${lastMessage}</div>
                    </div>
                `;
                userChatsListDiv.appendChild(chatItem);
            }

            if (!hasChats) {
                userChatsListDiv.innerHTML = '<p class="text-gray-400 text-center">No active chats. Start one!</p>';
            }
        }

        function showStartChatModal() {
            if (!isSignedIn) {
                showToast('Please sign in to start a personal chat.', 'error');
                return;
            }
            document.getElementById('start-chat-modal').classList.add('show');
            document.getElementById('chat-partner-username').value = '';
        }

        function hideStartChatModal() {
            document.getElementById('start-chat-modal').classList.remove('show');
        }

        function startPersonalChat() {
            const partnerUsername = document.getElementById('chat-partner-username').value.trim();
            if (!partnerUsername) {
                showToast('Please enter a username.', 'error');
                return;
            }
            if (partnerUsername === currentUsername) {
                showToast('You cannot chat with yourself.', 'error');
                return;
            }

            const allUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
            if (!allUsers[partnerUsername]) {
                showToast('User not found.', 'error');
                return;
            }

            // Check if a chat already exists
            if (userConnections.personalChats[partnerUsername]) {
                showToast(`Chat with ${partnerUsername} already exists. Opening chat...`, 'info');
                hideStartChatModal();
                openPersonalChat(partnerUsername);
                return;
            }

            // Create a new personal chat entry
            userConnections.personalChats[partnerUsername] = {
                chatId: `personal_${currentUsername}_${partnerUsername}_${Date.now()}`, // Unique ID for this chat instance
                lastMessage: 'No messages yet.',
                messages: [] // Initialize messages array for this chat
            };
            saveUserConnections(currentUsername);

            // Also create an entry for the other user if they don't have one
            let partnerConnections = JSON.parse(localStorage.getItem(USER_CONNECTIONS_PREFIX + partnerUsername) || '{}');
            if (!partnerConnections.personalChats) {
                partnerConnections.personalChats = {};
            }
            if (!partnerConnections.personalChats[currentUsername]) {
                partnerConnections.personalChats[currentUsername] = {
                    chatId: userConnections.personalChats[partnerUsername].chatId,
                    lastMessage: 'No messages yet.',
                    messages: []
                };
                localStorage.setItem(USER_CONNECTIONS_PREFIX + partnerUsername, JSON.stringify(partnerConnections));
            }

            showToast(`Chat started with ${partnerUsername}!`, 'success');
            hideStartChatModal();
            loadUserChats(); // Refresh the chat list
            openPersonalChat(partnerUsername); // Open the new chat in the main chat interface
        }

        function openPersonalChat(partnerUsername) {
            if (!isSignedIn) {
                showToast('Please sign in to open chats.', 'error');
                return;
            }

            const chatInfo = userConnections.personalChats[partnerUsername];
            if (!chatInfo) {
                showToast('Chat not found.', 'error');
                return;
            }

            // Simulate loading this chat into the main chat interface
            // For a real application, you'd load messages from a backend/database
            // For this demo, we'll just switch the main chat to this "personal chat" context
            
            // First, save the current general AI chat history
            if (currentPage === 'chat' && chatHistory[currentChatId]) {
                saveChatMessages(); // Save the current AI chat before switching context
            }

            // Now, load the personal chat messages into the main chatHistory structure
            // This is a simplification; in a real app, you'd have separate chat UIs or a more complex state management
            currentChatId = chatInfo.chatId;
            chatHistory = {}; // Clear general AI chat history from memory
            chatHistory[currentChatId] = {
                id: currentChatId,
                title: `Chat with ${partnerUsername}`,
                messages: chatInfo.messages || [], // Load messages from personal chat
                created: new Date() // Or chatInfo.createdAt if stored
            };
            
            // Add a default message if the chat is new
            if (chatHistory[currentChatId].messages.length === 0) {
                chatHistory[currentChatId].messages.push({
                    content: `You are now chatting with ${partnerUsername}. Say hello!`,
                    isUser: false,
                    timestamp: new Date()
                });
            }

            switchPage('chat'); // Switch to the chat page
            loadChatMessages(); // Display the messages for this personal chat
            showToast(`Opened chat with ${partnerUsername}.`, 'info');
        }

        function openGroupChat(groupId) {
            if (!isSignedIn) {
                showToast('Please sign in to open group chats.', 'error');
                return;
            }

            const allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');
            const groupData = allGroups[groupId];

            if (!groupData) {
                showToast('Group chat not found.', 'error');
                return;
            }
            if (!groupData.members.includes(currentUsername)) {
                showToast('You are not a member of this group.', 'error');
                return;
            }

            // Save current general AI chat history
            if (currentPage === 'chat' && chatHistory[currentChatId]) {
                saveChatMessages();
            }

            // Load group chat messages into the main chatHistory structure
            currentChatId = groupId;
            chatHistory = {}; // Clear general AI chat history from memory
            chatHistory[currentChatId] = {
                id: currentChatId,
                title: `Group: ${groupData.name}`,
                messages: groupData.messages || [], // Load messages from group chat
                created: groupData.createdAt ? new Date(groupData.createdAt) : new Date()
            };

            // Add a default message if the chat is new
            if (chatHistory[currentChatId].messages.length === 0) {
                chatHistory[currentChatId].messages.push({
                    content: `Welcome to the group chat for "${groupData.name}"!`,
                    isUser: false,
                    timestamp: new Date()
                });
            }

            switchPage('chat'); // Switch to the chat page
            loadChatMessages(); // Display the messages for this group chat
            showToast(`Opened group chat "${groupData.name}".`, 'info');
        }

        // Override sendMessage to handle personal/group chats
        const originalSendMessage = sendMessage; // Store original function
        sendMessage = async function() {
            const input = document.getElementById('user-input');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;

            if (currentPage === 'chat' && currentChatId.toString().startsWith('personal_')) {
                // Handle personal chat message
                const parts = currentChatId.split('_');
                const user1 = parts[1];
                const user2 = parts[2];
                const otherUser = (user1 === currentUsername) ? user2 : user1;

                // Add message to current user's personal chat history
                if (userConnections.personalChats[otherUser]) {
                    userConnections.personalChats[otherUser].messages.push({
                        sender: currentUsername,
                        content: userMessage,
                        timestamp: new Date().toISOString()
                    });
                    userConnections.personalChats[otherUser].lastMessage = userMessage;
                    saveUserConnections(currentUsername);
                }

                // Add message to other user's personal chat history
                let otherUserConnections = JSON.parse(localStorage.getItem(USER_CONNECTIONS_PREFIX + otherUser) || '{}');
                if (otherUserConnections.personalChats && otherUserConnections.personalChats[currentUsername]) {
                    otherUserConnections.personalChats[currentUsername].messages.push({
                        sender: currentUsername,
                        content: userMessage,
                        timestamp: new Date().toISOString()
                    });
                    otherUserConnections.personalChats[currentUsername].lastMessage = userMessage;
                    localStorage.setItem(USER_CONNECTIONS_PREFIX + otherUser, JSON.stringify(otherUserConnections));
                }

                addMessageToDOM(userMessage, true); // Display user message
                input.value = '';
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                loadUserChats(); // Update chat list with last message
                return; // Do not send to AI
            } else if (currentPage === 'chat' && !isNaN(currentChatId) && currentChatId.toString().length === 13) { // Check if it's a group chat ID (timestamp)
                // Handle group chat message
                let allGroups = JSON.parse(localStorage.getItem(COMMUNITY_GROUPS_KEY) || '{}');
                if (allGroups[currentChatId]) {
                    allGroups[currentChatId].messages.push({
                        sender: currentUsername,
                        content: userMessage,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem(COMMUNITY_GROUPS_KEY, JSON.stringify(allGroups));
                    addMessageToDOM(userMessage, true); // Display user message
                    input.value = '';
                    document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                    loadUserChats(); // Update chat list with last message
                    return; // Do not send to AI
                }
            }
            
            // If not a personal or group chat, proceed with original AI message sending logic
            originalSendMessage();
        };

        // Initial calls on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial active nav item based on currentPage
            const initialNavItem = document.querySelector(`.nav-menu button[onclick="switchPage('${currentPage}')"]`);
            if (initialNavItem) {
                initialNavItem.classList.add('active');
            }

            if (currentPage === 'about') {
                document.querySelectorAll('.team-member').forEach((member, index) => {
                    setTimeout(() => {
                        member.classList.add('visible');
                    }, index * 200);
                });
            }
            
            // Initialize sign-in status and update UI
            isSignedIn = localStorage.getItem('isSignedIn') === 'true';
            currentUsername = localStorage.getItem('currentUsername') || '';
            currentNickname = localStorage.getItem('currentNickname') || ''; // Load nickname
            
            if (isSignedIn && currentUsername) {
                // When loading, also determine if the user has a Pro plan
                const users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
                if (users[currentUsername]) {
                    hasProPlan = users[currentUsername].plan === 'pro';
                    // Ensure nickname is set if it wasn't previously stored (for older accounts)
                    if (!users[currentUsername].nickname) {
                        users[currentUsername].nickname = currentUsername; // Default to username
                        localStorage.setItem(USERS_KEY, JSON.stringify(users));
                        currentNickname = currentUsername;
                        localStorage.setItem('currentNickname', currentNickname);
                    }
                }
                loadUserChatHistory(currentUsername); // Load chat history for signed-in user
                loadUserNotes(currentUsername); // Load notes for signed-in user
                loadUserProfile(currentUsername); // Load profile for signed-in user
                loadUserConnections(currentUsername); // Load user connections
            } else {
                // If not signed in, initialize a default chat
                chatHistory[currentChatId] = {
                    id: currentChatId,
                    title: "Chat 1",
                    messages: [
                        {
                            content: "Hello! How can I help you today?",
                            isUser: false,
                            timestamp: new Date()
                        }
                    ],
                    created: new Date()
                };
                loadChatMessages();
            }

            updateAuthUI();
            initializeResponseLimit();
            updateChatGreeting(); // Update greeting on load
            updateNotesUI(); // Initial update for notes page visibility
            updateProfileUI(); // Initial update for profile page visibility
            updateConnectUI(); // Initial update for connect page visibility

            // If the initial page is 'about-us', trigger animations
            if (currentPage === 'about-us') {
                animateCounts();
            }
        });
    </script>
</body>
</html>
